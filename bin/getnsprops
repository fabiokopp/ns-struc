#!/usr/bin/python
__doc__ = 'GETNSPROPS -- calculate NS properties from EoS data for EoS1, EoS2, ...'
__usage__ = 'getnsprops EoS1.csv,EoS2.csv,...'
__author__ = 'philippe.landry@ligo.org'
__date__ = '03-2019'

import numpy as np
from optparse import OptionParser
from tov import tov
from constants import *
from pltsetup import *

parser = OptionParser(usage=__usage__, description=__doc__)
parser.add_option('-p', '--props', default='R,M,Lambda', help='comma-separated list of NS properties to calculate, DEFAULT=R,M,Lambda', metavar='R,M,Lambda')
parser.add_option('-n', '--numrhoc', default=5e1, help='number of central densities to sample per EoS, DEFAULT=50', metavar='5e1')
parser.add_option('-r', '--rhorng', default='0.8,1.2e1', help='comma-separated min and max values for central density in units of rhonuc, DEFAULT=0.8,1.2e1', metavar='0.8,1.2e1')
parser.add_option('-s', '--stpi', default=1e1, help='starting step size for radial TOV integration in cm, DEFAULT=1e1', metavar='1e1')
parser.add_option('-N', '--numpts', default=1e3, help='number of points for radial TOV integration, DEFAULT=1e3', metavar='1e3')
parser.add_option('-m', '--maxr', default=2e6, help='radius endpoint in cm for surface finding algorithm, DEFAULT=2e6', metavar='2e6')
parser.add_option('-T', '--tol', default=1e0, help='pressure tolerance for surface finding algorithm in g/cm^3, DEFAULT=1e0', metavar='1e0')
parser.add_option('-d', '--dir', default='./eos/', help='path to directory housing EoS data, DEFAULT=./eos/', metavar='./eos/')
parser.add_option('-o', '--outdir', default='./dat/', help='path to output directory, DEFAULT=./dat/', metavar='./dat/')
parser.add_option('-t', '--tag', default='macro-', help='tag for output data file, DEFAULT=macro-', metavar='macro-')

opts, args = parser.parse_args()
eosnames = str(args[0]).split(',')
props = str(opts.props).split(',')
numprops = len(props)
rhorng = str(opts.rhorng).split(',')
rhoi, rhof = [float(rho) for rho in rhorng]
numrhoc = int(opts.numrhoc)
stp = float(opts.stpi)
numpts = int(opts.numpts)
maxr = float(opts.maxr)
tol = float(opts.tol)
indir = str(opts.dir)
outdir = str(opts.outdir)
tag = str(opts.tag)

# CALCULATE NS PROPERTIES FOR EACH EOS

for eosname in eosnames:

	shortname = eosname.split('.')[0]

	eospath = indir+eosname
	outfile = open(outdir+tag+shortname+".csv","w")
	outfile.write('rhoc,'+','.join(props)+'\n')
	
	eosdat = np.genfromtxt(eospath,names=True,delimiter=',')
	rhodat = eosdat['baryon_density'] # rest-mass energy density in units of g/cm^3
	pdat = eosdat['pressurec2'] # pressure in units of g/cm^3
	mudat = eosdat['energy_densityc2'] # total energy density in units of g/cm^3
	
	rhocs = np.linspace(max(rhoi*rhonuc,rhodat[0]),min(rhof*rhonuc,rhodat[-1]),numrhoc)
	
	properties = np.zeros((numrhoc,numprops+1))
	
	i = 0
	for rhoc in rhocs:
	
		macro = tov(eospath,rhoc,props,stp,numpts,maxr,tol)
		properties[i] = [item for List in [[rhoc],macro] for item in List]
		i = i+1

	np.savetxt(outfile,properties,delimiter=',')
